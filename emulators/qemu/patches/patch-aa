$NetBSD: patch-aa,v 1.6 2010/02/27 23:21:13 tnn Exp $

--- net/tap-bsd.c.orig	2010-02-23 20:54:38.000000000 +0000
+++ net/tap-bsd.c
@@ -27,6 +27,8 @@
 #include "sysemu.h"
 
 #ifdef __NetBSD__
+#include <sys/ioctl.h>
+#include <net/if.h>
 #include <net/if_tap.h>
 #endif
 
@@ -45,6 +47,9 @@ int tap_open(char *ifname, int ifname_si
     int fd;
     char *dev;
     struct stat s;
+#ifdef TAPGIFNAME
+    struct ifreq ifr;
+#endif
 
 #if defined(__FreeBSD__) || defined(__FreeBSD_kernel__)
     /* if no ifname is given, always start the search from tap0. */
@@ -75,14 +80,26 @@ int tap_open(char *ifname, int ifname_si
 #else
     TFR(fd = open("/dev/tap", O_RDWR));
     if (fd < 0) {
-        fprintf(stderr, "warning: could not open /dev/tap: no virtual network emulation\n");
+        fprintf(stderr, "warning: could not open /dev/tap: no virtual network emulation: %s\n", strerror(errno));
         return -1;
     }
 #endif
 
-    fstat(fd, &s);
+#ifdef TAPGIFNAME
+    if (ioctl (fd, TAPGIFNAME, (void*)&ifr) < 0) {
+       fprintf(stderr, "warning: could not open get tap name: %s\n",
+           strerror(errno));
+       return -1;
+    }
+    pstrcpy(ifname, ifname_size, ifr.ifr_name);
+#else
+    if (fstat(fd, &s) < 0) {
+        fprintf(stderr, "warning: could not stat /dev/tap: no virtual network emulation: %s\n", strerror(errno));
+        return -1;
+    }
     dev = devname(s.st_rdev, S_IFCHR);
     pstrcpy(ifname, ifname_size, dev);
+#endif
 
     if (*vnet_hdr) {
         /* BSD doesn't have IFF_VNET_HDR */
