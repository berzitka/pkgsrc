$NetBSD: patch-CVE-2011-3026,v 1.1 2012/02/18 15:16:59 drochner Exp $

from chromium rev.121492

--- pngrutil.c.orig	2012-02-01 05:00:34.000000000 +0000
+++ pngrutil.c
@@ -457,8 +457,15 @@ png_decompress_chunk(png_structp png_ptr
       {
          /* Success (maybe) - really uncompress the chunk. */
          png_size_t new_size = 0;
-         png_charp text = (png_charp)png_malloc_warn(png_ptr,
-             prefix_size + expanded_size + 1);
+	 png_charp text = NULL;
+	 /* Need to check for both truncation (64-bit platforms) and integer
+	  * overflow.
+	  */
+	 if (prefix_size + expanded_size > prefix_size &&
+	     prefix_size + expanded_size < 0xffffffffU)
+	 {
+	    text = png_malloc_warn(png_ptr, prefix_size + expanded_size + 1);
+	 }
 
          if (text != NULL)
          {
