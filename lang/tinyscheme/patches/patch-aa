$NetBSD: patch-aa,v 1.7 2010/08/12 10:22:41 asau Exp $

--- makefile.orig	2006-12-07 13:29:24.000000000 +0300
+++ makefile	2010-08-12 14:14:07.000000000 +0400
@@ -18,7 +18,7 @@
 #AR= echo
 
 # Unix, generally 
-CC = gcc -fpic 
+#CC = gcc -fpic 
 DEBUG=-g -Wall -Wno-char-subscripts -O 
 Osuf=o 
 SOsuf=so 
@@ -28,16 +28,17 @@
 OUT = -o $@ 
 RM= -rm -f
 AR= ar crs
+SYS_LIBS= -lm
  
 # Linux 
 LD = gcc 
 LDFLAGS = -shared 
 DEBUG=-g -Wno-char-subscripts -O
-SYS_LIBS= -ldl
+#SYS_LIBS= -ldl
 PLATFORM_FEATURES= -DSUN_DL=1
 
 # Cygwin
-PLATFORM_FEATURES = -DUSE_STRLWR=0
+#PLATFORM_FEATURES = -DUSE_STRLWR=0
 
  
 # Solaris 
@@ -57,19 +58,23 @@
 LIBTARGET = $(LIBPREFIX)tinyscheme.$(SOsuf) 
 STATICLIBTARGET = $(LIBPREFIX)tinyscheme.$(LIBsuf)
 
-all: $(LIBTARGET) $(STATICLIBTARGET) scheme$(EXE_EXT)
+all: $(STATICLIBTARGET) scheme$(EXE_EXT)
 
-%.$(Osuf): %.c 
-	$(CC) -I. -c $(DEBUG) $(FEATURES) $(DL_FLAGS) $< 
-
-$(LIBTARGET): $(OBJS) 
-	$(LD) $(LDFLAGS) $(OUT) $(OBJS) $(SYS_LIBS) 
+.c.$(Osuf):
+	$(LIBTOOL) --mode=compile $(CC) -I. -c $(DEBUG) $(FEATURES) $(DL_FLAGS) $< 
 
 scheme$(EXE_EXT): $(OBJS) 
-	$(CC) -o $@ $(DEBUG) $(OBJS) $(SYS_LIBS) 
+	$(LIBTOOL) --mode=link $(CC) -o $@ $(DEBUG) $(OBJS) $(LIBS:.a=.la) $(SYS_LIBS) 
 
 $(STATICLIBTARGET): $(OBJS)
-	$(AR) $@ $(OBJS)
+	$(LIBTOOL) --mode=link $(CC) -o $(.TARGET:.a=.la) $(OBJS:.o=.lo) -rpath $(PREFIX)/lib -version-info 1:39
+
+install: all
+	$(LIBTOOL) --mode=install $(BSD_INSTALL_LIB) $(STATICLIBTARGET:.a=.la) $(DESTDIR)$(PREFIX)/lib
+	$(LIBTOOL) --mode=install $(BSD_INSTALL_PROGRAM) scheme$(EXE_EXT) $(DESTDIR)$(PREFIX)/bin/tinyscheme
+	$(BSD_INSTALL_DATA_DIR) $(DESTDIR)$(PREFIX)/share/tinyscheme
+	$(BSD_INSTALL_DATA) init.scm $(DESTDIR)$(PREFIX)/share/tinyscheme
+	$(BSD_INSTALL_DATA) scheme.h $(DESTDIR)$(PREFIX)/include/tinyscheme.h
 
 $(OBJS): scheme.h scheme-private.h opdefines.h
 dynload.$(Osuf): dynload.h 
